<tool id="3dtrees_detailview" name="DetailView: Trees Species Classification" version="1.0.0">
    <description>Tree species classification using DetailView deep learning model</description>
    <requirements>
        <container type="docker">ghcr.io/3dtrees-earth/3dtrees_detailview:0.1.0</container>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        ln -s '$input' input.laz &&
        python3 -u /app/run.py 
        --dataset-path input.laz 
        --output-dir /out/
        --tree-id-col '$tree_id_col'
        --n-aug '$n_aug'
        --projection-backend '$projection_backend'
        --output-type both
        && cp /out/predictions.csv predictions.csv
        && cp /out/predictions_probs.csv predictions_probs.csv
        && cp /out/pc_with_species.laz pc_with_species.laz
    ]]>
    </command>
    <inputs>
        <param name="input" type="data" format="binary" label="Input Point Cloud" help="Input LAS/LAZ point cloud file with segmented trees"/>
        <param name="tree_id_col" type="text" value="PredInstance" label="Tree ID Column" help="Column name in the LAS file that contains tree instance IDs"/>
        <param name="n_aug" type="integer" value="1" min="1" max="50" label="Number of Augmentations" help="Number of augmentation iterations for prediction (higher = more accurate but slower)"/>
        <param name="projection_backend" type="select" label="Projection Backend" help="Backend for point cloud projection">
            <option value="numpy">NumPy</option>
            <option value="torch" selected="true">PyTorch</option>
        </param>
    </inputs>
    <outputs>
        <data name="predictions_csv" format="csv" label="Species Predictions" from_work_dir="predictions.csv">
            <actions>
                <action name="column_names" type="metadata" default="filename,species_id,species_prob,tree_H,species"/>
            </actions>
        </data>
        <data name="predictions_probs_csv" format="csv" label="Species Probabilities" from_work_dir="predictions_probs.csv">
            <actions>
                <action name="column_names" type="metadata" default="File,..."/>
            </actions>
        </data>
        <data name="predictions_laz" format="binary" label="Classified Point Cloud" from_work_dir="pc_with_species.laz"/>
    </outputs>
    <tests>
        <test expect_num_outputs="3">
            <param name="input" value="segmentation_7.laz"/>
            <param name="tree_id_col" value="PredInstance"/>
            <param name="n_aug" value="1"/>
            <param name="projection_backend" value="torch"/>
            <output name="predictions_csv">
                <assert_contents>
                    <has_size value="0" delta="0" negate="true"/>
                </assert_contents>
            </output>
            <output name="predictions_probs_csv">
                <assert_contents>
                    <has_size value="0" delta="0" negate="true"/>
                </assert_contents>
            </output>
            <output name="predictions_laz">
                <assert_contents>
                    <has_size value="0" delta="0" negate="true"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
**What it does**

This tool performs tree species classification on segmented 3D point clouds using the DetailView deep learning model. The model uses multiple projection views (side, top, bottom, and detail views) of individual trees to classify them into one of 33 tree species.

**Input Requirements**

- Input must be a LAS/LAZ file with segmented individual trees
- Each tree must have a unique identifier in a specified column (default: PredInstance)
- Point clouds should contain at least 50 points per tree
- Trees with fewer points will be skipped

**Supported Species**

The model can classify 33 tree species including:
- Abies alba, Acer campestre, Acer pseudoplatanus, Betula pendula
- Carpinus betulus, Fagus sylvatica, Fraxinus excelsior
- Picea abies, Pinus sylvestris, Quercus robur, Quercus petraea
- And 22 other species (see lookup.csv for complete list)

**Parameters**

- **Tree ID Column**: Name of the column in the LAS file containing tree instance IDs (default: TreeID)
- **Number of Augmentations**: Number of random augmentations to average predictions over (default: 10)
  - Higher values = more accurate but slower
  - Recommended: 10-20 for production, 5 for testing
- **Projection Backend**: 
  - NumPy: Original implementation, matches published results
  - PyTorch: Faster alternative with minimal accuracy difference

**Outputs**

1. **Species Predictions (CSV)**: Main results file containing:
   - filename: Tree identifier
   - species_id: Numeric species code
   - species_prob: Confidence score (0-1)
   - tree_H: Tree height in meters
   - species: Species name (Latin binomial)

2. **Species Probabilities (CSV)**: Detailed probability matrix with probability for each species for each tree

3. **Classified Point Cloud (LAZ)**: Original point cloud with two additional attributes per point:
   - species_id: Species classification
   - species_prob: Classification confidence

**Citation**

When using this tool, please cite:

Puliti et al. (2024) Benchmarking tree species classification from proximally-sensed laser scanning data: 
introducing the FOR-species20K dataset. ArXiv. https://www.arxiv.org/abs/2408.06507

**Model Information**

- Model: DenseNet201 ensemble with multi-view fusion
- Training dataset: FOR-species20K
- DOI: 10.5281/zenodo.14204431
    ]]></help>
    <citations>
        <citation type="doi">10.5281/zenodo.14204431</citation>
        <citation type="bibtex">
@misc{detailview2024,
  title = {DetailView: Tree species classification for 3D4EcoTec},
  author = {Schindler, Zoe and Frey, Julian},
  year = {2024},
  doi = {10.5281/zenodo.14204431}
}
        </citation>
    </citations>
</tool>
